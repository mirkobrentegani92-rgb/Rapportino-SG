<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SG SOLARGARDA SRL – Bolla Magazzino (semplice)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
  :root{
    --a4-w:210mm; --a4-h:297mm; --pad:10mm;
    --fg:#0f172a; --muted:#475569; --line:#0f172a; --bg:#f6f7fb;
    --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,sans-serif;
  }
  html,body{height:100%;background:var(--bg)}
  body{margin:0;font-family:var(--font);color:var(--fg)}
  .app{display:grid;grid-template-columns:420px 1fr;gap:18px;padding:18px}
  .panel{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;position:sticky;top:18px;box-shadow:0 2px 6px rgba(15,23,42,.05)}
  .panel h2{margin:0 0 12px;font-size:18px}
  .grid{display:grid;gap:10px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;font-size:14px;background:#fff}
  textarea{resize:vertical;min-height:60px}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{appearance:none;border:1px solid #0f172a;background:#0f172a;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn-secondary{background:#fff;color:#0f172a;border-color:#cbd5e1}

  .sheet{width:var(--a4-w);min-height:var(--a4-h);background:#fff;margin:0 auto;border:1px solid #e5e7eb;box-shadow:0 2px 6px rgba(15,23,42,.05);position:relative}
  .sheet-inner{padding:var(--pad)}
  .header{display:grid;grid-template-columns:1fr auto;gap:8mm;align-items:center;border-bottom:2px solid var(--line);padding-bottom:6mm;margin-bottom:6mm}
  .brand-name{font-weight:900;letter-spacing:.6px;font-size:18pt}
  .brand-sub{color:var(--muted);font-size:10pt}
  .logo-box{width:24mm;height:24mm;border:1px dashed #cbd5e1;display:grid;place-items:center;font-size:10px;color:#94a3b8;overflow:hidden;border-radius:4px}
  .logo-box img{max-width:100%;max-height:100%;object-fit:contain;display:block}

  table{width:100%;border-collapse:collapse;margin-top:3mm;font-size:10.5pt}
  th,td{border:1px solid var(--line);padding:2.5mm}
  th{background:#f8fafc;text-align:left}
  .section-title{margin-top:4mm;margin-bottom:2mm;font-weight:800;font-size:11pt;letter-spacing:.2px}

  .signature-box{border:1px solid var(--line);height:24mm;display:grid;place-items:center;border-radius:4px;margin-top:6mm;position:relative;overflow:hidden}
  .signature-box .hint{position:absolute;top:4px;left:6px;font-size:9pt;color:#64748b}
  .signature-box img{width:100%;height:100%;object-fit:contain;display:block}

  .footer{position:absolute;left:0;right:0;bottom:0;border-top:1.5px solid var(--line);padding:4mm var(--pad);font-size:9.5pt;color:var(--fg);display:flex;justify-content:space-between;align-items:center}
  .footer .contact{line-height:1.35}

  @media (max-width:980px){.app{grid-template-columns:1fr}.panel{position:static;order:2}.sheet{order:1}}
  @page{size:A4;margin:10mm}
  @media print{body{background:#fff}.panel{display:none !important}.app{display:block;padding:0}.sheet{border:none;box-shadow:none;margin:0}}
</style>
</head>
<body>
<div class="app">
  <!-- PANNELLO -->
  <div class="panel">
    <h2>Bolla magazzino (semplice)</h2>
    <div class="grid">
      <div class="row-2">
        <div><label>Tipo movimento</label>
          <select id="tipo">
            <option value="uscita">Uscita da magazzino</option>
            <option value="entrata">Entrata in magazzino</option>
            <option value="reso">Reso da cantiere</option>
          </select>
        </div>
        <div><label>Data</label><input type="date" id="data"/></div>
      </div>
      <div class="row-2">
        <div><label>Commessa (se uscita)</label><input type="text" id="commessa" placeholder="Es. 027"/></div>
        <div><label>Operatore</label><input type="text" id="operatore" placeholder="Nome Cognome"/></div>
      </div>
      <div><label>Note bolla</label><textarea id="note" placeholder="Es. materiale riutilizzato da magazzino..."></textarea></div>

      <div class="section-title">Aggiungi riga</div>
      <div class="row-2">
        <div><label>Articolo</label><input type="text" id="articolo" placeholder="Sacco cemento 25kg"/></div>
        <div><label>UM</label><input type="text" id="um" placeholder="pz, sacchi, m..."/></div>
      </div>
      <div class="row-2">
        <div><label>Quantità</label><input type="number" step="0.01" id="qty" value="1"/></div>
        <div><label>&nbsp;</label><button type="button" id="add" class="btn-secondary">Aggiungi riga</button></div>
      </div>

      <div class="row-2">
        <div>
          <label>Firma</label>
          <canvas id="pad" style="width:100%;height:120px;border:1px solid #d1d5db;border-radius:10px;background:#fff;touch-action:none;"></canvas>
          <div class="btns"><button type="button" class="btn-secondary" id="clearSig">Pulisci firma</button></div>
        </div>
        <div>
          <label>Logo aziendale (opzionale)</label>
          <input type="file" id="logo" accept="image/*"/>
        </div>
      </div>

      <div class="btns">
        <button type="button" id="stampa">Stampa / Chiudi bolla</button>
        <button type="button" id="reset" class="btn-secondary">Svuota</button>
      </div>
    </div>
  </div>

  <!-- FOGLIO A4 -->
  <div class="sheet" id="sheet">
    <div class="sheet-inner">
      <div class="header">
        <div>
          <div class="brand-name">BOLLA MAGAZZINO – <span id="pv-tipo">USCITA</span></div>
          <div class="brand-sub">
            Data: <span id="pv-data"></span> — Operatore: <span id="pv-operatore"></span> — Commessa: <span id="pv-commessa"></span>
          </div>
        </div>
        <div class="logo-box" id="pv-logo"><span>LOGO</span></div>
      </div>

      <div class="section-title">Righe bolla</div>
      <table id="pv-table"><thead><tr><th style="width:60%;">Articolo</th><th style="width:15%;">UM</th><th style="width:15%;">Quantità</th><th style="width:10%;">Segn.</th></tr></thead><tbody></tbody></table>

      <div class="section-title">Note</div>
      <table><tbody><tr><td id="pv-note" style="height:30mm;"></td></tr></tbody></table>

      <div class="section-title">Firma consegna / ritiro</div>
      <div class="signature-box"><span class="hint" id="hint-firma">Firma qui</span><img id="pv-firma" alt="Firma"/></div>
    </div>
    <div class="footer"><div class="contact">
      SG SOLARGARDA SRL — Via d’Annunzio 9, Castelnuovo del Garda, Verona, Italy — info@solargarda.it
    </div></div>
  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const tipo=$('tipo'), data=$('data'), commessa=$('commessa'), operatore=$('operatore'), note=$('note');
  const articolo=$('articolo'), um=$('um'), qty=$('qty'), add=$('add'), logo=$('logo');
  const pvTipo=$('pv-tipo'), pvData=$('pv-data'), pvCommessa=$('pv-commessa'), pvOperatore=$('pv-operatore'), pvTable=$('pv-table').querySelector('tbody'), pvNote=$('pv-note');
  const pvLogo=$('pv-logo'), pvFirma=$('pv-firma'), hintFirma=$('hint-firma');
  const todayISO=new Date().toISOString().slice(0,10); data.value=todayISO;

  // Firma – canvas ad alta definizione e export ridimensionato per non "esplodere" nel box
  const pad=$('pad'), ctx=pad.getContext('2d'); let drawing=false, prev=null;
  function resize(){const r=pad.getBoundingClientRect(); const ratio=Math.max(window.devicePixelRatio||1,1);
    pad.width=Math.floor(r.width*ratio); pad.height=Math.floor(r.height*ratio);
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(ratio,ratio);
    ctx.lineWidth=1.6; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#0f172a';
  }
  new ResizeObserver(resize).observe(pad); resize();
  function pos(e){const r=pad.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top};}
  function start(e){drawing=true; prev=pos(e); e.preventDefault(); hintFirma.style.display='none';}
  function move(e){if(!drawing)return; const p=pos(e); ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(p.x,p.y); ctx.stroke(); prev=p; e.preventDefault(); updatePreview();}
  function end(){drawing=false; prev=null; updatePreview();}
  pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
  pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);
  $('clearSig').onclick=()=>{const r=pad.getBoundingClientRect(); ctx.clearRect(0,0,r.width,r.height); hintFirma.style.display='block'; updatePreview();};

  function signatureDataURL(){
    // Ridimensiono l'immagine della firma a una dimensione "comoda" per il box PDF
    const targetW = 900, targetH = 300; // orizzontale
    const off=document.createElement('canvas');
    off.width=targetW; off.height=targetH;
    const octx=off.getContext('2d');
    octx.fillStyle='#ffffff'; octx.fillRect(0,0,targetW,targetH);
    const img=new Image(); img.src=pad.toDataURL('image/png');
    return new Promise(res=>{
      img.onload=()=>{
        const sw=img.width, sh=img.height;
        const scale=Math.min(targetW/sw, targetH/sh);
        const dw=sw*scale, dh=sh*scale;
        const dx=(targetW-dw)/2, dy=(targetH-dh)/2;
        octx.drawImage(img, dx, dy, dw, dh);
        res(off.toDataURL('image/png'));
      };
      img.onerror=()=>res(pad.toDataURL('image/png'));
    });
  }

  // Logo upload
  logo.addEventListener('change',()=>{
    const f=logo.files[0];
    if(!f){ pvLogo.innerHTML='<span>LOGO</span>'; return; }
    const img=new Image();
    img.onload=()=>{ pvLogo.innerHTML=''; pvLogo.appendChild(img); };
    img.src=URL.createObjectURL(f);
  });

  // Righe bolla
  let rows=[];
  add.onclick=()=>{
    const r={articolo:articolo.value.trim(), um:um.value.trim(), qty:parseFloat(qty.value||'0')||0};
    if(!r.articolo || !r.um || !r.qty){ alert('Compila articolo, UM e quantità'); return; }
    rows.push(r); articolo.value=''; um.value=''; qty.value='1'; renderRows(); updatePreview();
  };
  function renderRows(){
    pvTable.innerHTML='';
    for(let i=0;i<Math.max(5,rows.length);i++){
      const r=rows[i]||{articolo:'',um:'',qty:''};
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.articolo}</td><td>${r.um}</td><td>${r.qty}</td><td></td>`;
      pvTable.appendChild(tr);
    }
  }

  async function updatePreview(){
    pvTipo.textContent = (tipo.value==='uscita'?'USCITA': tipo.value==='entrata'?'ENTRATA':'RESO');
    pvData.textContent = data.value?data.value.split('-').reverse().join('/'):'—';
    pvCommessa.textContent = commessa.value||'—';
    pvOperatore.textContent = operatore.value||'—';
    pvNote.textContent = note.value||'';
    try{
      const url = await signatureDataURL();
      pvFirma.src = url;
    }catch(e){ pvFirma.src = pad.toDataURL('image/png'); }
  }

  [tipo,data,commessa,operatore,note].forEach(el=>el.addEventListener('input',updatePreview));

  // Stampa
  $('stampa').onclick=async()=>{
    await updatePreview();
    window.print();
  };

  window.addEventListener('afterprint', ()=>{
    rows=[]; renderRows(); updatePreview();
  });

  // Init
  renderRows(); updatePreview();
})();</script>
</body>
</html>
